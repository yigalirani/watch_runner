{
  "version": 3,
  "sources": ["../src/index.ts"],
  "sourcesContent": ["\nimport { spawn } from 'node:child_process';\nimport { watch } from 'node:fs';\ntype FilterFunc=(line:string)=>string|true|false //string-show just the string  +line number, true show as is, false dont show\nconst green='\\x1b[40m\\x1b[32m'\nconst red='\\x1b[40m\\x1b[31m'\nconst reset='\\x1b[0m'\nexport const eslint_linting_code:FilterFunc=(line:string)=>{\n  if (line.split(' eslintrc:').length>1)\n    return false\n  const split=line.split(' eslint:')[1]//Linting code for ');\n  if (split==null)\n    return true\n  const split2=split.split('Linting code for ')[1]\n  if (split2==null)\n    return false\n  return split2\n}\nfunction waitForAbort(controller: AbortController): Promise<void> {\n  const { signal } = controller;\n  controller.abort()\n  return new Promise<void>((resolve) => {\n    if (signal.aborted) {\n      resolve();\n      return;\n    }\n    signal.addEventListener('abort', () => resolve(), { once: true });\n  });\n}\nclass WorkerListenr{\n  start_time:number=0\n  last_line=''\n  count=0\n  filter:FilterFunc\n  effective_title:string\n  reason:string\n  constructor(filter:FilterFunc,effective_title:string,reason:string){\n    this.reason=reason\n    this.filter=filter\n    this.effective_title=effective_title\n  }\n  print_filtered(line:string){\n    const filtered=this.filter(line)\n    if (filtered===false)\n      return \n    if (filtered===true){\n      console.log(line)\n      return \n    }\n    console.log(this.count++,filtered)\n  }  \n  start(){\n    process.stdout.write('\\x1Bc'); //clear screen\n    console.log('running:',green,this.effective_title,reset) \n    console.log('reason :',green,this.reason,reset)\n    console.log('cli    :',green,process.argv.slice(1).join(' '),reset)\n    console.log('time   :',green,new Date().toLocaleTimeString('en-US', { hour12: true }),reset)\n    this.start_time=Date.now()\n  }\n  elapsed(){\n    return `elapsed: ${Date.now()-this.start_time} ms`\n  }\n  flush(){\n    this.print_filtered(this.last_line)\n  }\n  exit(code:number){\n    this.flush()\n    if (code===0)\n      console.log(green,'done ok ',reset,this.elapsed())\n    else\n      console.log(red,'done with fail code',code,reset,this.elapsed())\n  }\n\n  error(err:unknown){\n    this.flush()\n    const message=err instanceof Error?err.message:String(err)\n    console.log(red,'failed',message,reset,this.elapsed())\n  }\n  data(a:string){\n    const total_text=this.last_line+a\n    const lines=total_text.split('\\n')\n    for (const  line of lines.slice(0,-1))\n      this.print_filtered(line)\n  \n    this.last_line=lines.at(-1)||''\n  }\n}\n\nfunction allways_true(_a:string){\n  return true\n}\n\nfunction run_cmd({\n  cmd,\n  worker_listener\n}: {\n  cmd: string;\n  worker_listener:WorkerListenr\n}):AbortController {\n  const ans=new AbortController()\n  const {signal}=ans\n  void new Promise((resolve, _reject) => { \n  \n    const child = spawn(cmd, {\n      signal,\n      shell: true,\n      env: { ...process.env, FORCE_COLOR: \"1\" },  \n    });\n    child.on('spawn',()=>worker_listener.start())\n    child.stdout.on(\"data\", (data:unknown) => worker_listener.data(String(data)))\n    child.stderr.on(\"data\", (data:unknown) => worker_listener.data(String(data)))\n    child.on(\"exit\", (code) => {\n      if (code!=null)\n        worker_listener.exit(code)\n      resolve(null);\n    });\n\n    child.on(\"error\", (err) => {\n      worker_listener.error(err)\n      resolve(null);\n    });\n  });\n  return ans\n}\n\nexport  async function run({cmd,title,watchfiles=[],filter=allways_true}:{\n  cmd:string\n  title?:string\n  watchfiles?:string[]\n  filter?:FilterFunc\n}){\n  const effective_title=function(){\n    if (title!=null)\n      return title\n    if (typeof cmd==='string') \n      return cmd\n    return ''\n  }()\n  let last_run=0\n  let last_changed=0\n  let filename_changed=''\n  function runit(reason:string){\n    last_run=Date.now()\n    let controller=new AbortController()\n    const worker_listener=new WorkerListenr(filter,effective_title||'',reason)\n    try{\n      controller=run_cmd({cmd:cmd,worker_listener})\n    }catch(ex){\n      worker_listener.error(ex)  \n      //console.log(`failed ${effective_title||''} ${duration} ms: ${String(ex)}`)      \n    }\n    return controller\n  }\n  let controller=runit('initial')\n  for (const filename of watchfiles){\n    try{\n      console.log(`watching ${filename}`)\n      watch(filename,{},(eventType, changed_file) => {\n        const changed=`*${filename}/${changed_file} `  \n        //console.log(changed);\n        last_changed=Date.now()\n        filename_changed=changed\n      }) \n    }catch(ex){\n      console.warn(`file not found, ignoring ${filename}: ${String(ex)}`)  \n    }\n  }\n  while (true) { \n    //console.log('loop',last_changed , last_run,last_changed > last_run)\n    if (last_changed > last_run) {  \n      await waitForAbort(controller)\n      controller= runit(filename_changed)\n    }\n    await new Promise(r => setTimeout(r, 1000)); // wait 1s before next iteration\n  }  \n}\n"],
  "mappings": "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",
  "names": ["controller"]
}
